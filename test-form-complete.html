<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Form Completo</title>
    <style>
        /* Stili del form */
        .fp-resv-simple {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .fp-step {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .fp-step.active {
            display: block;
        }
        
        .fp-meal-btn {
            display: inline-block;
            padding: 15px 30px;
            margin: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .fp-meal-btn:hover {
            border-color: #007cba;
        }
        
        .fp-meal-btn.selected {
            background-color: #007cba;
            color: white;
            border-color: #007cba;
        }
        
        .fp-party-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }
        
        .fp-party-btn {
            background-color: #007cba;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }
        
        .fp-party-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .fp-party-display {
            margin: 0 20px;
            font-size: 18px;
            font-weight: bold;
        }
        
        input[type="date"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .fp-time-slot {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .fp-time-slot:hover {
            border-color: #007cba;
        }
        
        .fp-time-slot.selected {
            background-color: #007cba;
            color: white;
            border-color: #007cba;
        }
        
        .fp-time-slot.disabled {
            background-color: #f5f5f5;
            color: #999;
            cursor: not-allowed;
        }
        
        button {
            background-color: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        
        button:hover {
            background-color: #005a87;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="fp-resv-default" class="fp-resv-simple">
        <h2>Test Form Prenotazioni</h2>
        
        <!-- Step 1: Selezione Pasto -->
        <div class="fp-step active" data-step="1">
            <h3>Seleziona il servizio</h3>
            <button class="fp-meal-btn" data-meal="pranzo">Pranzo</button>
            <button class="fp-meal-btn" data-meal="cena">Cena</button>
        </div>
        
        <!-- Step 2: Data e Persone -->
        <div class="fp-step" data-step="2">
            <h3>Seleziona data e numero di persone</h3>
            
            <div class="fp-party-selector">
                <button class="fp-party-btn" id="party-minus">-</button>
                <div class="fp-party-display">
                    <span id="party-count">2</span> <span id="party-label">persone</span>
                </div>
                <button class="fp-party-btn" id="party-plus">+</button>
            </div>
            
            <input type="hidden" id="party-size" value="2">
            
            <div style="margin: 20px 0;">
                <label for="reservation-date">Data prenotazione:</label>
                <input type="date" id="reservation-date" required>
            </div>
            
            <div id="date-loading" class="loading" style="display: none;">
                Caricamento date disponibili...
            </div>
            
            <div id="date-info" style="display: none;">
                <p>Seleziona una data disponibile dal calendario sopra.</p>
            </div>
            
            <div id="time-loading" class="loading" style="display: none;">
                Caricamento orari disponibili...
            </div>
            
            <div id="time-slots" style="margin: 20px 0;"></div>
            
            <div id="time-info" style="display: none;">
                <p>Seleziona un orario disponibile.</p>
            </div>
        </div>
        
        <!-- Step 3: Dati Personali -->
        <div class="fp-step" data-step="3">
            <h3>I tuoi dati</h3>
            <div style="display: flex; gap: 10px; margin: 10px 0;">
                <input type="text" id="customer-first-name" placeholder="Nome" required style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="customer-last-name" placeholder="Cognome" required style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <input type="email" id="customer-email" placeholder="Email" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;">
            <input type="tel" id="customer-phone" placeholder="Telefono" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;">
            <label style="display: flex; align-items: center; margin: 10px 0;">
                <input type="checkbox" name="fp_resv_consent" required style="margin-right: 10px;">
                Accetto il trattamento dei dati personali
            </label>
        </div>
        
        <!-- Step 4: Riepilogo -->
        <div class="fp-step" data-step="4">
            <h3>Riepilogo prenotazione</h3>
            <div id="summary-content">
                <p><strong>Servizio:</strong> <span id="summary-meal">-</span></p>
                <p><strong>Data:</strong> <span id="summary-date">-</span></p>
                <p><strong>Orario:</strong> <span id="summary-time">-</span></p>
                <p><strong>Persone:</strong> <span id="summary-party">-</span></p>
                <p><strong>Nome:</strong> <span id="summary-name">-</span></p>
                <p><strong>Email:</strong> <span id="summary-email">-</span></p>
                <p><strong>Telefono:</strong> <span id="summary-phone">-</span></p>
            </div>
        </div>
        
        <!-- Pulsanti di navigazione -->
        <div style="text-align: center; margin: 20px 0;">
            <button id="prev-btn" style="display: none;">Indietro</button>
            <button id="next-btn">Avanti</button>
            <button id="submit-btn" style="display: none;">Conferma Prenotazione</button>
        </div>
        
        <!-- Campi nascosti per il form -->
        <input type="hidden" name="fp_resv_meal" value="">
        <input type="hidden" name="fp_resv_date" value="">
        <input type="hidden" name="fp_resv_time" value="">
        <input type="hidden" name="fp_resv_slot_start" value="">
        <input type="hidden" name="fp_resv_party" value="">
        <input type="hidden" name="fp_resv_phone_cc" value="">
        <input type="hidden" name="fp_resv_phone_local" value="">
        <input type="hidden" name="fp_resv_phone_e164" value="">
    </div>

    <script>
        // JavaScript del form integrato direttamente
        console.log('JavaScript del form caricato!');

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM caricato, inizializzo form...');
            const form = document.getElementById('fp-resv-default');
            console.log('Form trovato:', form);
            
            if (!form) {
                console.error('Form non trovato!');
                return;
            }
            
            let currentStep = 1;
            const totalSteps = 4;
            
            const steps = form.querySelectorAll('.fp-step');
            const progressSteps = form.querySelectorAll('.fp-progress-step');
            const nextBtn = document.getElementById('next-btn');
            const prevBtn = document.getElementById('prev-btn');
            const submitBtn = document.getElementById('submit-btn');
            
            // Meal selection - dynamic
            let mealBtns = form.querySelectorAll('.fp-meal-btn');
            let selectedMeal = null;
            let selectedTime = null;

            function setupMealButtons() {
                mealBtns = form.querySelectorAll('.fp-meal-btn');
                console.log('Trovati', mealBtns.length, 'pulsanti pasto');
                mealBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        console.log('Pulsante pasto cliccato:', this.dataset.meal);
                        mealBtns.forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedMeal = this.dataset.meal;
                        
                        // Load available dates for selected meal
                        loadAvailableDates(selectedMeal);
                    });
                });
            }
            
            // Initialize meal buttons
            setupMealButtons();
            
            // Initialize party size selector
            setupPartySelector();
            
            function setupPartySelector() {
                const minusBtn = document.getElementById('party-minus');
                const plusBtn = document.getElementById('party-plus');
                const countDisplay = document.getElementById('party-count');
                const labelDisplay = document.getElementById('party-label');
                const hiddenInput = document.getElementById('party-size');
                
                let partyCount = 2; // Default value
                const minParty = 1;
                const maxParty = 20;
                
                function updatePartyDisplay() {
                    countDisplay.textContent = partyCount;
                    labelDisplay.textContent = partyCount === 1 ? 'persona' : 'persone';
                    hiddenInput.value = partyCount;
                    
                    // Update button states
                    minusBtn.disabled = partyCount <= minParty;
                    plusBtn.disabled = partyCount >= maxParty;
                    
                    // Trigger change event to load time slots
                    hiddenInput.dispatchEvent(new Event('change'));
                    
                    console.log('Party count updated:', partyCount);
                }
                
                minusBtn.addEventListener('click', function() {
                    if (partyCount > minParty) {
                        partyCount--;
                        updatePartyDisplay();
                    }
                });
                
                plusBtn.addEventListener('click', function() {
                    if (partyCount < maxParty) {
                        partyCount++;
                        updatePartyDisplay();
                    }
                });
                
                // Initialize display
                updatePartyDisplay();
            }
            
            // Load available dates when meal is selected
            function loadAvailableDates(meal) {
                if (!meal) return;
                
                console.log('Caricamento date per meal:', meal);
                
                // Show loading indicator
                const loadingEl = document.getElementById('date-loading');
                const infoEl = document.getElementById('date-info');
                loadingEl.style.display = 'block';
                infoEl.style.display = 'none';
                
                const today = new Date().toISOString().split('T')[0];
                const to = new Date();
                to.setMonth(to.getMonth() + 3); // 3 months ahead
                const toDate = to.toISOString().split('T')[0];
                
                const url = `/wp-json/fp-resv/v1/available-days?from=${today}&to=${toDate}&meal=${meal}`;
                console.log('URL richiesta:', url);
                
                fetch(url)
                    .then(response => {
                        console.log('Risposta ricevuta:', response);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Dati ricevuti:', data);
                        // Hide loading indicator
                        loadingEl.style.display = 'none';
                        
                        if (data && data.days) {
                            // Store available dates
                            const availableDates = Object.keys(data.days).filter(date => {
                                return data.days[date] && data.days[date].available;
                            });
                            
                            // Show info if dates are available
                            if (availableDates.length > 0) {
                                infoEl.style.display = 'block';
                            }
                            
                            console.log('Date disponibili per', meal, ':', availableDates);
                        } else {
                            // No data available, allow all dates
                            infoEl.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('Errore nel caricamento date disponibili:', error);
                        // Hide loading indicator
                        loadingEl.style.display = 'none';
                        // Show error message
                        infoEl.innerHTML = `<div class="error">Errore nel caricamento delle date: ${error.message}</div>`;
                        infoEl.style.display = 'block';
                    });
            }
            
            // Set minimum date to today
            const dateInput = document.getElementById('reservation-date');
            const today = new Date().toISOString().split('T')[0];
            dateInput.min = today;
            
            // Navigation
            function showStep(step) {
                steps.forEach(s => s.classList.remove('active'));
                
                const currentStepEl = form.querySelector(`[data-step="${step}"]`);
                if (currentStepEl) {
                    currentStepEl.classList.add('active');
                }
                
                // Update buttons
                prevBtn.style.display = step > 1 ? 'block' : 'none';
                nextBtn.style.display = step < totalSteps ? 'block' : 'none';
                submitBtn.style.display = step === totalSteps ? 'block' : 'none';
            }
            
            function validateStep(step) {
                switch(step) {
                    case 1:
                        return selectedMeal !== null;
                    case 2:
                        const date = document.getElementById('reservation-date').value;
                        const party = document.getElementById('party-size').value;
                        return date !== '' && party !== '' && parseInt(party) > 0;
                    case 3:
                        const firstName = document.getElementById('customer-first-name').value;
                        const lastName = document.getElementById('customer-last-name').value;
                        const email = document.getElementById('customer-email').value;
                        const phone = document.getElementById('customer-phone').value;
                        const consent = document.querySelector('input[name="fp_resv_consent"]').checked;
                        return firstName !== '' && lastName !== '' && email !== '' && phone !== '' && consent;
                    case 4:
                        return true;
                }
                return true;
            }
            
            nextBtn.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    currentStep++;
                    showStep(currentStep);
                } else {
                    alert('Per favore completa tutti i campi richiesti.');
                }
            });
            
            prevBtn.addEventListener('click', function() {
                currentStep--;
                showStep(currentStep);
            });
            
            submitBtn.addEventListener('click', function() {
                if (validateStep(currentStep)) {
                    alert('Prenotazione inviata! (Questo è un demo)');
                } else {
                    alert('Per favore completa tutti i campi richiesti.');
                }
            });
        });
    </script>
</body>
</html>
