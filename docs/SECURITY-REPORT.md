# Security Sweep â€” 2025-09-30

## Overview
- Audit scope: REST routes registered by FP Restaurant Reservations and supporting security controls (nonces, capabilities, sanitization, escaping).
- Methodology: reviewed each `register_rest_route` declaration, traced permission callbacks, and inspected handlers for nonce usage, rate limiting, and data sanitization.
- Result: all routes enforce the expected capability or nonce; inputs are sanitized before persistence or processing; responses rely on sanitized payloads and WordPress REST serialization for output escaping.

## Public REST Endpoints
| Route | Methods | Purpose | Auth / Nonce | Input Validation & Guards | Output Handling |
|-------|---------|---------|--------------|---------------------------|-----------------|
| `/fp-resv/v1/availability` | GET | Fetch open slots | Public (read-only) | Date regex (`YYYY-MM-DD`), party `absint`, optional IDs sanitized; invalid input returns `WP_Error`. | Returns slot arrays computed server-side; values originate from sanitized repository data. |
| `/fp-resv/v1/reservations` | POST | Create reservation | Nonce `fp_resv_submit`; rate-limit (5/5min), honeypot, captcha filter, consent check. | Payload collected via `sanitize_text_field` and sanitized again in `Service::sanitizePayload`; rejects missing consent. | Response built from sanitized reservation data via `rest_ensure_response`. |
| `/fp-resv/v1/events` | GET | List upcoming events | Public (read-only) | Limit enforced with `absint` default; service filters by schedule. | Returns event arrays generated by domain service (sanitized on storage). |
| `/fp-resv/v1/events/(?P<id>\d+)` | GET | Fetch single event | Public (read-only) | Event ID `absint`; missing/invalid triggers 400/404. | Returns sanitized event array. |
| `/fp-resv/v1/events/(?P<id>\d+)/tickets` | POST | Book event tickets | Nonce `fp_resv_events`; rate-limit (5/5min). | Contact fields sanitized with `sanitize_text_field`; quantity `absint`; tokenized consent fields optional. | Response merges sanitized ticket + tracking payload through `rest_ensure_response`. |
| `/fp-resv/v1/payments/confirm` | POST | Refresh Stripe payment status client-side | Nonce `fp_resv_submit`. | Reservation/payment IDs via `absint`; intent ID `sanitize_text_field`; mismatches rejected. | Response returns sanitized payment and reservation summary. |
| `/fp-resv/v1/surveys` | POST | Submit post-visit survey | Token-based (reservation ID + email hash). | Reservation ID `absint`; email `sanitize_email` + `is_email`; stars/NPS clamped; comment `sanitize_textarea_field`. | HTML snippet rendered from trusted templates; fallback message escaped with `esc_html`. |

## Authenticated REST Endpoints
| Route | Methods | Capability / Auth | Input Validation | Output Handling |
|-------|---------|-------------------|------------------|-----------------|
| `/fp-resv/v1/email-test` | POST | `manage_options` via permission callback. | Email sanitized with `sanitize_email` (fallback admin email); optional note `sanitize_text_field`. | Message assembled with `esc_html` for dynamic values. |
| `/fp-resv/v1/privacy/export` | GET | `manage_options`. | Email `sanitize_email` + `is_email`. | Returns filtered export array. |
| `/fp-resv/v1/privacy/delete` | DELETE | `manage_options`. | Email `sanitize_email` + `is_email`. | Returns counts + message via `rest_ensure_response`. |
| `/fp-resv/v1/agenda` (+ subroutes) | GET/POST/PATCH | `manage_options` through `AdminREST::checkPermissions`. | Dates validated with regex, statuses constrained to `Service::ALLOWED_STATUSES`, numeric IDs `absint`, notes/allergies sanitized. | Responses map repository rows; strings sanitized on insert/update. |
| `/fp-resv/v1/reservations/arrivals` | GET | `manage_options`. | Range constrained to `today|week`; filters sanitized via `sanitize_text_field`. | Returns arrays produced from sanitized rows. |
| `/fp-resv/v1/agenda/reservations/(?P<id>\d+)/move` | POST | `manage_options`. | Date regex, time validated, IDs `absint`. | Returns sanitized agenda entry. |
| `/fp-resv/v1/events/(?P<id>\d+)/tickets` | GET | `manage_options`. | Event ID `absint`. | Returns ticket arrays from service. |
| `/fp-resv/v1/events/(?P<id>\d+)/tickets/export` | GET | `manage_options`. | Event ID `absint`. | CSV generated server-side; headers set explicitly. |
| `/fp-resv/v1/closures` (+ preview) | GET/POST/PUT/DELETE | `Security::currentUserCanManage()` (maps to `manage_options`). | Payload filtered via `sanitize_text_field`, `sanitize_key`, integer casts; date ranges parsed with `DateTimeImmutable`. | Responses built from sanitized closure models; JSON serialization handles escaping. |
| `/fp-resv/v1/tables/*` | CRUD | `manage_options`. | JSON payload normalized via `preparePayload` (`sanitize_text_field` per string); IDs `absint`. | Returns layout arrays; data sanitized at save. |
| `/fp-resv/v1/payments/(?P<id>\d+)/(capture|void|refund)` | POST | `manage_options`. | IDs `absint`; optional refund amount coerced to non-negative float. | Responses expose sanitized payment + reservation info. |
| `/fp-resv/v1/reports/*` | GET | `manage_options` (returns `WP_Error` otherwise). | Query params `sanitize_text_field`; pagination ints cast. | Responses produced by reports service; export endpoint base64-encodes CSV payload. |

## Additional Controls
- **Rate limiting & anti-bot**: front-end reservation and event booking routes enforce IP-based throttling (`RateLimiter::allow`) and honeypot/captcha hooks.
- **Consent & privacy**: reservation creation requires explicit consent flag; privacy endpoints gated behind admin capability.
- **Output escaping**: REST responses return JSON via `rest_ensure_response`. Dynamic strings interpolated into HTML (emails, survey fallback) are wrapped with `esc_html`/`esc_html__` to prevent injection.
- **Stripe flows**: confirmation endpoint validates nonce + matches intent against stored payment before calling Stripe service.

## Findings & Recommendations
- No missing nonce or capability checks identified.
- Sanitization coverage is consistent across public input points; any future endpoints should reuse helper methods (`sanitize_text_field`, `absint`, `Security::currentUserCanManage`).
- Continue leveraging `rest_ensure_response` and `esc_html` for responses that embed HTML fragments.

No code changes are required as part of this sweep.
