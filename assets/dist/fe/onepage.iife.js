var FPResv=(function(f){"use strict";function E(s,t){if(!s)return null;if(typeof s.closest=="function")return s.closest("["+t+"]");let e=s;for(;e;){if(e.hasAttribute(t))return e;e=e.parentElement}return null}function F(s){return E(s,"data-fp-resv-section")}function w(s,t){s&&(t?(s.setAttribute("aria-disabled","true"),s.setAttribute("disabled","disabled")):(s.removeAttribute("disabled"),s.setAttribute("aria-disabled","false")))}function C(s){return s?s.querySelector('input:not([type="hidden"]), select, textarea, button, [tabindex="0"]'):null}function u(s,t){if(!s)return null;const e=Object.assign({event:s},t||{});return window.dataLayer=window.dataLayer||[],window.dataLayer.push(e),window.fpResvTracking&&typeof window.fpResvTracking.dispatch=="function"&&window.fpResvTracking.dispatch(e),e}function _(s){const t=s.getAttribute("data-fp-resv");if(!t)return{};try{return JSON.parse(t)}catch(e){window.console&&window.console.warn&&console.warn("[fp-resv] Impossibile analizzare il dataset del widget",e)}return{}}class P{constructor(){this.state={started:!1,formValidEmitted:!1,sectionStates:{},unlocked:{},initialHint:"",hintOverride:"",ctaEnabled:!1,sending:!1,pendingAvailability:!1,pendingAvailabilityOptions:null,lastAvailabilityParams:null,mealAvailability:{},touchedFields:{}}}getState(){return this.state}setState(t){this.state={...this.state,...t}}updateSectionState(t,e){this.state.sectionStates[t]=e}getSectionState(t){return this.state.sectionStates[t]||"locked"}markFieldAsTouched(t){this.state.touchedFields[t]=!0}isFieldTouched(t){return!!this.state.touchedFields[t]}setHintOverride(t){this.state.hintOverride=t}getHintOverride(){return this.state.hintOverride}setSending(t){this.state.sending=t}isSending(){return this.state.sending}setCtaEnabled(t){this.state.ctaEnabled=t}isCtaEnabled(){return this.state.ctaEnabled}setStarted(t){this.state.started=t}isStarted(){return this.state.started}setFormValidEmitted(t){this.state.formValidEmitted=t}isFormValidEmitted(){return this.state.formValidEmitted}}const k=/\D+/g;function g(s){return s?String(s).replace(k,""):""}function p(s){const t=g(s);return t===""?"":t.replace(/^0+/,"")}function c(s){return g(s)}function I(s,t){const e=p(s),i=c(t);return e===""||i===""?"":"+"+e+i}function b(s){const t=c(s);return t.length>=6&&t.length<=15}function q(s){const t=c(s);if(t==="")return{masked:"",digits:""};const e=[3,4],i=[];let r=0,n=0;for(;r<t.length;){const a=t.length-r;let o=e[n%e.length];a<=4&&(o=a),i.push(t.slice(r,r+o)),r+=o,n+=1}return{masked:i.join(" "),digits:t}}function v(s,t){const e=s.value,{masked:i}=q(e),r=s.selectionStart;if(s.value=i,r!==null){const n=i.length-e.length,a=Math.max(0,r+n);s.setSelectionRange(a,a)}s.setAttribute("data-phone-local",c(s.value)),s.setAttribute("data-phone-cc",p(t))}function S(s,t){const e=c(s.value),i=p(t);return{e164:I(i,e),local:e,country:i}}class V{constructor(t,e,i,r,n){this.form=t,this.phoneField=e,this.phonePrefixField=i,this.phoneCountryCode=r,this.copy=n}isSectionValid(t){const e=t.querySelectorAll("[data-fp-resv-field]");if(e.length===0)return!0;if((t.getAttribute("data-step")||"")==="slots"){const n=this.form?this.form.querySelector('[data-fp-resv-field="time"]'):null,a=this.form?this.form.querySelector('input[name="fp_resv_slot_start"]'):null,o=n&&n.value.trim()!=="",l=a&&a.value.trim()!=="";if(!o||!l)return!1}let r=!0;return Array.prototype.forEach.call(e,function(n){typeof n.checkValidity=="function"&&!n.checkValidity()&&(r=!1)}),r}findFirstInvalid(t){return t?t.querySelector("[data-fp-resv-field]:invalid, [required]:invalid"):null}focusFirstInvalid(){const t=this.form.querySelector("[data-fp-resv-field]:invalid, [required]:invalid");t&&typeof t.focus=="function"&&t.focus()}validatePhoneField(){if(!this.phoneField)return;const t=S(this.phoneField,this.phoneCountryCode);if(t.local===""){this.phoneField.setCustomValidity(""),this.phoneField.removeAttribute("aria-invalid");return}return b(t.local)?(this.phoneField.setCustomValidity(""),this.phoneField.setAttribute("aria-invalid","false"),!0):(this.phoneField.setCustomValidity(this.copy.invalidPhone),this.phoneField.setAttribute("aria-invalid","true"),!1)}validateEmailField(t){if(typeof t.value=="string"){const e=t.value.trim();e!==t.value&&(t.value=e)}return t.value.trim()===""?(t.setCustomValidity(""),t.removeAttribute("aria-invalid"),!0):(t.setCustomValidity(""),t.checkValidity()?(t.setCustomValidity(""),t.setAttribute("aria-invalid","false"),!0):(t.setCustomValidity(this.copy.invalidEmail),t.setAttribute("aria-invalid","true"),!1))}updateInlineErrors(t,e){if(!this.form)return;const i={first_name:this.form.querySelector('[data-fp-resv-field="first_name"]'),last_name:this.form.querySelector('[data-fp-resv-field="last_name"]'),email:this.form.querySelector('[data-fp-resv-field="email"]'),phone:this.form.querySelector('[data-fp-resv-field="phone"]'),consent:this.form.querySelector('[data-fp-resv-field="consent"]')},r={first_name:e?.messages?.required_first_name||"Inserisci il nome",last_name:e?.messages?.required_last_name||"Inserisci il cognome",email:this.copy.invalidEmail,phone:this.copy.invalidPhone,consent:e?.messages?.required_consent||"Accetta la privacy per procedere"};Object.keys(i).forEach(n=>{const a=i[n],o=this.form.querySelector(`[data-fp-resv-error="${n}"]`);if(!o)return;if(n==="consent"&&!t[n]){o.textContent="",o.hidden=!0;return}let l=!1,d="";if(a&&typeof a.checkValidity=="function"&&!a.checkValidity()&&(l=!0,d=r[n]||""),n==="email"&&a&&a.value&&a.value.trim()!==""&&a.checkValidity()&&(l=!1,d=""),n==="phone"&&this.phoneField){const h=S(this.phoneField,this.phoneCountryCode);h.local&&!b(h.local)&&(l=!0,d=this.copy.invalidPhone)}n==="consent"&&a&&a.checked&&(l=!1,d=""),l?(o.textContent=d,o.hidden=!1,a&&a.setAttribute&&a.setAttribute("aria-invalid","true")):(o.textContent="",o.hidden=!0,a&&a.removeAttribute&&a.removeAttribute("aria-invalid"))})}}class x{constructor(t,e,i,r,n,a){this.sections=t,this.stepOrder=e,this.state=i,this.updateSectionAttributes=r,this.updateProgressIndicators=n,this.updateSubmitState=a}getStepOrderIndex(t){const e=t&&t.getAttribute?t.getAttribute("data-step")||"":String(t||""),i=typeof e=="string"?e:"",r=this.stepOrder.indexOf(i);return r===-1?this.stepOrder.length+1:r}ensureSectionActive(t){const e=t.getAttribute("data-step")||"";this.state.sectionStates[e]==="locked"&&(this.state.sectionStates[e]="active",this.updateSectionAttributes(t,"active"),this.dispatchSectionUnlocked(e),this.scrollIntoView(t))}completeSection(t,e){const i=t.getAttribute("data-step")||"";if(this.state.sectionStates[i]==="completed"||(this.state.sectionStates[i]="completed",this.updateSectionAttributes(t,"completed"),this.updateProgressIndicators(),!e))return;const r=this.sections.indexOf(t);if(r===-1)return;const n=this.sections[r+1];if(!n)return;const a=n.getAttribute("data-step")||String(r+1);this.state.sectionStates[a]!=="completed"&&(this.state.sectionStates[a]="active",this.updateSectionAttributes(n,"active"),this.dispatchSectionUnlocked(a),this.scrollIntoView(n))}navigateToPrevious(t){const e=this.sections.indexOf(t);if(e<=0)return;const i=this.sections[e-1];if(!i)return;const r=i.getAttribute("data-step")||"";r&&this.activateSectionByKey(r)}navigateToNext(t,e){const i=t.getAttribute("data-step")||"";if(i==="date"||i==="party"){this.completeSection(t,!0);return}if(i==="slots"){const r=this.form?this.form.querySelector('[data-fp-resv-field="time"]'):null,n=this.form?this.form.querySelector('input[name="fp_resv_slot_start"]'):null;if(!r||r.value.trim()===""||!n||n.value.trim()===""){const a=this.sections.find(o=>(o.getAttribute("data-step")||"")==="slots");if(a){const o=a.querySelector("[data-fp-resv-slots-status]");o&&(o.textContent=this.copy.slotRequired||"Seleziona un orario per continuare.",o.style.color="#dc2626",o.setAttribute("data-state","error"),setTimeout(()=>{o.textContent="",o.style.color="",o.removeAttribute("data-state")},3e3))}return}}if(!e.isSectionValid(t)){const r=e.findFirstInvalid(t);r&&(typeof r.reportValidity=="function"&&r.reportValidity(),typeof r.focus=="function"&&r.focus({preventScroll:!1}));return}this.completeSection(t,!0)}activateSectionByKey(t){const e=this.sections.find(function(r){return(r.getAttribute("data-step")||"")===t});if(!e)return;let i=!1;this.sections.forEach(r=>{const n=r.getAttribute("data-step")||"";if(n===t)i=!0,this.updateSectionAttributes(r,"active",{silent:!0}),this.dispatchSectionUnlocked(n);else if(i)this.updateSectionAttributes(r,"locked",{silent:!0});else{const o=this.state.sectionStates[n]==="locked"?"locked":"completed";this.updateSectionAttributes(r,o,{silent:!0})}}),this.updateProgressIndicators(),this.scrollIntoView(e),requestAnimationFrame(()=>{const r=e.querySelector('input, select, textarea, button, [tabindex]:not([tabindex="-1"])');r&&typeof r.focus=="function"&&r.focus({preventScroll:!0})}),this.updateSubmitState()}dispatchSectionUnlocked(t){this.state.unlocked[t]||(this.state.unlocked[t]=!0,this.events.section_unlocked)}scrollIntoView(t){typeof t.scrollIntoView=="function"&&t.scrollIntoView({behavior:"smooth",block:"start"});const e=C(t);e&&typeof e.focus=="function"&&e.focus({preventScroll:!0})}}function m(s){if(s==null)return"";if(typeof s=="string")return s.trim();if(Array.isArray(s))return s.map(e=>m(e)).filter(e=>e!=="").join("; ");if(typeof s=="object"){if(typeof s.message=="string"&&s.message.trim()!=="")return s.message.trim();if(typeof s.detail=="string"&&s.detail.trim()!=="")return s.detail.trim()}return String(s).trim()}function L(s){if(s==null)return"";const t=Array.isArray(s)?[...s]:[s];for(;t.length>0;){const e=t.shift();if(e==null)continue;if(Array.isArray(e)){t.push(...e);continue}if(typeof e!="object"){const r=m(e);if(r!=="")return r;continue}const i=["details","detail","debug","error"];for(let r=0;r<i.length;r+=1){const n=i[r];if(Object.prototype.hasOwnProperty.call(e,n)){const a=m(e[n]);if(a!=="")return a}}Object.prototype.hasOwnProperty.call(e,"data")&&e.data&&typeof e.data=="object"&&t.push(e.data)}return""}function R(s,t){const e=L(t);return e===""?s:s?s.includes(e)?s:s+" ("+e+")":e}const O=typeof window<"u"&&typeof window.requestIdleCallback=="function"?s=>window.requestIdleCallback(s):s=>window.setTimeout(()=>s(Date.now()),1),T=["date","party","slots","details","confirm"];class y{constructor(t){this.root=t,this.dataset=_(t),this.config=this.dataset.config||{},this.strings=this.dataset.strings||{},this.messages=this.strings.messages||{},this.events=this.dataset&&this.dataset.events||{},this.integrations=this.config.integrations||this.config.features||{},this.form=t.querySelector("[data-fp-resv-form]");const e=Array.from(T);this.sections=this.form?Array.prototype.slice.call(this.form.querySelectorAll("[data-fp-resv-section]")):[];const i=this.sections.map(r=>r.getAttribute("data-step")||"").filter(Boolean);this.stepOrder=Array.from(new Set(e.concat(i))),this.sections.length>1&&this.sections.sort((r,n)=>this.getStepOrderIndex(r)-this.getStepOrderIndex(n)),this.progress=this.form?this.form.querySelector("[data-fp-resv-progress]"):null,this.progressItems=this.progress?Array.prototype.slice.call(this.progress.querySelectorAll("[data-step]")):[],this.progress&&this.progressItems.length>1&&this.progressItems.sort((r,n)=>this.getStepOrderIndex(r)-this.getStepOrderIndex(n)).forEach(r=>{this.progress.appendChild(r)}),this.submitButton=this.form?this.form.querySelector("[data-fp-resv-submit]"):null,this.submitLabel=this.submitButton?this.submitButton.querySelector("[data-fp-resv-submit-label]")||this.submitButton:null,this.submitSpinner=this.submitButton?this.submitButton.querySelector("[data-fp-resv-submit-spinner]"):null,this.submitHint=this.form?this.form.querySelector("[data-fp-resv-submit-hint]"):null,this.stickyCta=this.form?this.form.querySelector("[data-fp-resv-sticky-cta]"):null,this.successAlert=this.form?this.form.querySelector("[data-fp-resv-success]"):null,this.errorAlert=this.form?this.form.querySelector("[data-fp-resv-error]"):null,this.errorMessage=this.form?this.form.querySelector("[data-fp-resv-error-message]"):null,this.errorRetry=this.form?this.form.querySelector("[data-fp-resv-error-retry]"):null,this.mealButtons=Array.prototype.slice.call(t.querySelectorAll("[data-fp-resv-meal]")),this.mealNotice=t.querySelector("[data-fp-resv-meal-notice]"),this.mealNoticeText=this.mealNotice?this.mealNotice.querySelector("[data-fp-resv-meal-notice-text]")||this.mealNotice:null,this.hiddenMeal=this.form?this.form.querySelector('input[name="fp_resv_meal"]'):null,this.hiddenPrice=this.form?this.form.querySelector('input[name="fp_resv_price_per_person"]'):null,this.hiddenSlot=this.form?this.form.querySelector('input[name="fp_resv_slot_start"]'):null,this.dateField=this.form?this.form.querySelector('[data-fp-resv-field="date"]'):null,this.partyField=this.form?this.form.querySelector('[data-fp-resv-field="party"]'):null,this.summaryTargets=Array.prototype.slice.call(t.querySelectorAll("[data-fp-resv-summary]")),this.phoneField=this.form?this.form.querySelector('[data-fp-resv-field="phone"]'):null,this.phonePrefixField=this.form?this.form.querySelector('[data-fp-resv-field="phone_prefix"]'):null,this.hiddenPhoneE164=this.form?this.form.querySelector('input[name="fp_resv_phone_e164"]'):null,this.hiddenPhoneCc=this.form?this.form.querySelector('input[name="fp_resv_phone_cc"]'):null,this.hiddenPhoneLocal=this.form?this.form.querySelector('input[name="fp_resv_phone_local"]'):null,this.availabilityRoot=this.form?this.form.querySelector("[data-fp-resv-slots]"):null,this.availabilityIndicator=this.form?this.form.querySelector("[data-fp-resv-availability-indicator]"):null,this.state=new P,this.formValidation=new V(this.form,this.phoneField,this.phonePrefixField,this.getPhoneCountryCode(),this.copy),this.formNavigation=new x(this.sections,this.stepOrder,this.state.getState(),this.updateSectionAttributes.bind(this),this.updateProgressIndicators.bind(this),this.updateSubmitState.bind(this)),this.copy={ctaDisabled:this.messages.cta_complete_fields||"Completa i campi richiesti",ctaEnabled:this.messages.cta_book_now||this.strings.actions&&this.strings.actions.submit||"Prenota ora",ctaSending:this.messages.cta_sending||"Invio…",updatingSlots:this.messages.msg_updating_slots||"Aggiornamento disponibilità…",slotsUpdated:this.messages.msg_slots_updated||"Disponibilità aggiornata.",slotsEmpty:this.messages.slots_empty||"",selectMeal:this.messages.msg_select_meal||"Seleziona un servizio per visualizzare gli orari disponibili.",slotsError:this.messages.msg_slots_error||"Impossibile aggiornare la disponibilità. Riprova.",slotRequired:this.messages.slot_required||"Seleziona un orario per continuare.",invalidPhone:this.messages.msg_invalid_phone||"Inserisci un numero di telefono valido (minimo 6 cifre).",invalidEmail:this.messages.msg_invalid_email||"Inserisci un indirizzo email valido.",submitError:this.messages.msg_submit_error||"Non è stato possibile completare la prenotazione. Riprova.",submitSuccess:this.messages.msg_submit_success||"Prenotazione inviata con successo.",mealFullNotice:this.messages.meal_full_notice||"Nessuna disponibilità per questo servizio. Scegli un altro giorno."},this.phoneCountryCode=this.getPhoneCountryCode(),this.hiddenPhoneCc&&this.hiddenPhoneCc.value===""&&(this.hiddenPhoneCc.value=this.phoneCountryCode),this.handleDelegatedTrackingEvent=this.handleDelegatedTrackingEvent.bind(this),this.handleReservationConfirmed=this.handleReservationConfirmed.bind(this),this.handleWindowFocus=this.handleWindowFocus.bind(this),!(!this.form||this.sections.length===0)&&(this.bind(),this.initializeSections(),this.initializePhoneField(),this.initializeMeals(),this.initializeDateField(),this.initializeAvailability(),this.syncConsentState(),this.updateSubmitState(),this.updateInlineErrors(),this.updateSummary(),O(()=>{this.loadStripeIfNeeded(),this.loadGoogleCalendarIfNeeded()}))}getStepOrderIndex(t){return this.formNavigation.getStepOrderIndex(t)}updateSectionAttributes(t,e,i={}){const r=t.getAttribute("data-step")||"",n=i&&i.silent===!0;this.state.updateSectionState(r,e),t.setAttribute("data-state",e),e==="completed"?t.setAttribute("data-complete-hidden","true"):t.removeAttribute("data-complete-hidden");const a=e==="active";t.setAttribute("aria-hidden",a?"false":"true"),t.setAttribute("aria-expanded",a?"true":"false"),a?(t.hidden=!1,t.removeAttribute("hidden"),t.removeAttribute("inert"),t.style.display="block",t.style.visibility="visible",t.style.opacity="1"):(t.hidden=!0,t.setAttribute("hidden",""),t.setAttribute("inert",""),t.style.display="none",t.style.visibility="hidden",t.style.opacity="0"),n||this.updateProgressIndicators(),this.updateStickyCtaVisibility()}updateInlineErrors(){this.formValidation.updateInlineErrors(this.state.getState().touchedFields,this.strings)}bind(){const t=this.handleFormInput.bind(this);this.form.addEventListener("input",t,!0),this.form.addEventListener("change",t,!0),this.form.addEventListener("focusin",this.handleFirstInteraction.bind(this)),this.form.addEventListener("blur",this.handleFieldBlur.bind(this),!0),this.form.addEventListener("keydown",this.handleKeydown.bind(this),!0),this.form.addEventListener("click",this.handleNavClick.bind(this)),this.form.addEventListener("submit",this.handleSubmit.bind(this)),this.root.addEventListener("click",this.handleDelegatedTrackingEvent),this.progress&&(this.progress.addEventListener("click",this.handleProgressClick.bind(this)),this.progress.addEventListener("keydown",this.handleProgressKeydown.bind(this))),this.errorRetry&&this.errorRetry.addEventListener("click",this.handleRetrySubmit.bind(this)),document.addEventListener("fp-resv:reservation:confirmed",this.handleReservationConfirmed),window.addEventListener("fp-resv:reservation:confirmed",this.handleReservationConfirmed),window.addEventListener("focus",this.handleWindowFocus)}initializeSections(){const t=this;this.sections.forEach(function(e,i){const r=e.getAttribute("data-step")||String(i);t.state.updateSectionState(r,i===0?"active":"locked"),i===0&&t.dispatchSectionUnlocked(r),t.updateSectionAttributes(e,t.state.getSectionState(r),{silent:!0})}),this.updateProgressIndicators()}initializeMeals(){const t=this;this.mealButtons.length!==0&&this.mealButtons.forEach(function(e){if(!e.hasAttribute("data-meal-default-notice")){const i=e.getAttribute("data-meal-notice")||"";i!==""&&e.setAttribute("data-meal-default-notice",i)}e.addEventListener("click",function(i){i.preventDefault(),t.handleFirstInteraction(),t.handleMealSelection(e)}),e.hasAttribute("data-active")&&t.hiddenMeal&&t.applyMealSelection(e)})}initializePhoneField(){if(this.phonePrefixField){this.updatePhoneCountryFromPrefix();return}this.phoneField&&v(this.phoneField,this.getPhoneCountryCode())}initializeDateField(){if(!this.dateField)return;const t=new Date().toISOString().split("T")[0];this.dateField.setAttribute("min",t),this.dateField.addEventListener("change",e=>{const i=e.target.value;i&&i<t?(e.target.setCustomValidity("Non è possibile prenotare per giorni passati."),e.target.setAttribute("aria-invalid","true")):(e.target.setCustomValidity(""),e.target.setAttribute("aria-invalid","false"))})}initializeAvailability(){this.availabilityRoot&&this.availabilityRoot.addEventListener("click",t=>{if(this.availabilityController)return;const e=t.target instanceof HTMLElement?t.target.closest("button[data-slot]"):null;if(!e)return;t.preventDefault();const i={start:e.getAttribute("data-slot")||"",label:e.textContent||"",status:e.getAttribute("data-slot-status")||""},r=this.availabilityRoot.querySelectorAll("button[data-slot]");Array.prototype.forEach.call(r,n=>{n.setAttribute("aria-pressed",n===e?"true":"false")}),this.handleSlotSelected(i)})}handleFormInput(t){const e=t.target;if(!e)return;this.handleFirstInteraction(),e===this.phoneField?v(this.phoneField,this.getPhoneCountryCode()):e===this.phonePrefixField&&this.updatePhoneCountryFromPrefix(),this.updateSummary();const i=e.getAttribute("data-fp-resv-field")||"",r=i&&e.dataset.fpResvLastValue||"",n=i&&typeof e.value=="string"?e.value:"",a=!i||r!==n,o=F(e);if(!o){this.isConsentField(e)&&this.syncConsentState(),this.updateSubmitState();return}this.formNavigation.ensureSectionActive(o),this.updateSectionAttributes(o,"active"),i&&(e.dataset.fpResvLastValue=n),(i==="date"||i==="party"||i==="slots"||i==="time")&&((i==="date"||i==="party")&&a&&this.clearSlotSelection({schedule:!1}),(i!=="date"||a||t.type==="change")&&this.scheduleAvailabilityUpdate()),this.isConsentField(e)&&this.syncConsentState(),this.updateSubmitState(),this.updateInlineErrors()}handleFieldBlur(t){const e=t.target;if(!e||!(e instanceof HTMLElement))return;const i=e.getAttribute("data-fp-resv-field");i&&(this.state.markFieldAsTouched(i),i==="phone"&&this.phoneField&&this.formValidation.validatePhoneField(),i==="email"&&e instanceof HTMLInputElement&&this.formValidation.validateEmailField(e),this.updateInlineErrors())}handleKeydown(t){if(t.key!=="Enter")return;const e=t.target;!e||!(e instanceof HTMLElement)||e.tagName==="TEXTAREA"||e instanceof HTMLButtonElement&&e.type==="submit"||(e instanceof HTMLInputElement&&e.type||"")==="submit"||t.preventDefault()}handleNavClick(t){const e=t.target instanceof HTMLElement?t.target.closest("[data-fp-resv-nav]"):null;if(!e)return;const i=e.closest("[data-fp-resv-section]");if(!i)return;t.preventDefault(),t.stopPropagation(),this.handleFirstInteraction();const r=e.getAttribute("data-fp-resv-nav");console.log("[FP-RESV] Navigation click:",r,"section:",i.getAttribute("data-step")),r==="prev"?this.formNavigation.navigateToPrevious(i):r==="next"&&this.formNavigation.navigateToNext(i,this.formValidation)}handleSubmit(t){if(t.preventDefault(),this.state.markFieldAsTouched("consent"),!this.form.checkValidity())return this.form.reportValidity(),this.formValidation.focusFirstInvalid(),this.updateInlineErrors(),this.updateSubmitState(),!1;const e=this.events.submit||"reservation_submit",i=this.collectAvailabilityParams();u(e,{source:"form",form_id:this.form&&this.form.id?this.form.id:this.root.id||"",date:i.date,party:i.party,meal:i.meal}),this.preparePhonePayload(),this.state.setSending(!0),this.updateSubmitState(),this.clearError();const r=this.serializeForm(),n=this.getReservationEndpoint(),a=performance.now();let o=0;return fetch(n,{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json","X-WP-Nonce":r.fp_resv_nonce||""},body:JSON.stringify(r),credentials:"same-origin"}).then(l=>(o=Math.round(performance.now()-a),u("ui_latency",{op:"submit",ms:o}),l.ok?l.json():l.json().then(d=>{const h=d&&d.message||this.copy.submitError;throw Object.assign(new Error(h),{status:l.status,payload:d})}))).then(l=>{this.handleSubmitSuccess(l)}).catch(l=>{o||(o=Math.round(performance.now()-a),u("ui_latency",{op:"submit",ms:o})),this.handleSubmitError(l,o)}).finally(()=>{this.state.setSending(!1),this.updateSubmitState()}),!1}handleFirstInteraction(){if(this.state.isStarted())return;const t=this.events.start||"reservation_start";u(t,{source:"form"}),this.state.setStarted(!0)}handleRetrySubmit(t){t.preventDefault(),this.clearError(),this.formValidation.focusFirstInvalid(),this.updateSubmitState()}handleSubmitSuccess(t){this.clearError();const e=t&&t.message||this.copy.submitSuccess;if(this.successAlert&&(this.successAlert.textContent=e,this.successAlert.hidden=!1,typeof this.successAlert.focus=="function"&&this.successAlert.focus()),this.form){this.form.setAttribute("data-state","submitted");const i=this.form.querySelectorAll("input, select, textarea, button");Array.prototype.forEach.call(i,r=>{try{r.setAttribute("disabled","disabled")}catch{}})}}handleSubmitError(t,e){const i=t&&typeof t.status=="number"?t.status:"unknown",r=t&&t.message||this.copy.submitError,n=t&&typeof t=="object"&&t.payload||null,a=R(r,n);this.errorAlert&&this.errorMessage&&(this.errorMessage.textContent=a,this.errorAlert.hidden=!1,requestAnimationFrame(()=>{typeof this.errorAlert.scrollIntoView=="function"&&this.errorAlert.scrollIntoView({behavior:"smooth",block:"center"}),typeof this.errorAlert.focus=="function"&&(this.errorAlert.setAttribute("tabindex","-1"),this.errorAlert.focus({preventScroll:!0}))})),this.state.setHintOverride(a),this.updateSubmitState();const o=this.events.submit_error||"submit_error";u(o,{code:i,latency:e})}clearError(){this.errorAlert&&(this.errorAlert.hidden=!0),this.state.setHintOverride("")}updateProgressIndicators(){this.progress}updateSubmitState(){if(!this.submitButton)return;const t=this.form.checkValidity();if(this.state.isSending()?this.setSubmitButtonState(!1,"sending"):this.setSubmitButtonState(t,null),this.submitHint){const e=this.state.getHintOverride()||(t?this.state.getState().initialHint:this.copy.ctaDisabled);this.submitHint.textContent=e}}setSubmitButtonState(t,e){if(!this.submitButton)return;const i=e==="sending"?!1:!!t;w(this.submitButton,!i),this.submitLabel&&(e==="sending"?this.submitLabel.textContent=this.copy.ctaSending:i?this.submitLabel.textContent=this.copy.ctaEnabled:this.submitLabel.textContent=this.copy.ctaDisabled),this.submitSpinner&&(this.submitSpinner.hidden=e!=="sending"),this.state.setCtaEnabled(i)}updateSummary(){}syncConsentState(){}updateStickyCtaVisibility(){}clearSlotSelection(){}scheduleAvailabilityUpdate(){}handleSlotSelected(){}handleMealSelection(){}applyMealSelection(){}updatePhoneCountryFromPrefix(){}getPhoneCountryCode(){return"39"}collectAvailabilityParams(){return{}}serializeForm(){return{}}preparePhonePayload(){}getReservationEndpoint(){return"/wp-json/fp-resv/v1/reservations"}isConsentField(){return!1}handleDelegatedTrackingEvent(){}handleReservationConfirmed(){}handleWindowFocus(){}loadStripeIfNeeded(){}loadGoogleCalendarIfNeeded(){}dispatchSectionUnlocked(){}}typeof window<"u"&&(window.FPResv=window.FPResv||{},window.FPResv.FormApp=y,window.fpResvApp=window.FPResv);function A(){console.log("[FP-RESV] Plugin v0.1.5 loaded - Complete form functionality active (Optimized)");const s=document.querySelectorAll("[data-fp-resv]");console.log("[FP-RESV] Found widgets:",s.length),Array.prototype.forEach.call(s,function(t){try{new y(t),console.log("[FP-RESV] Widget initialized:",t.id||"unnamed")}catch(e){console.error("[FP-RESV] Error initializing widget:",e)}})}return document.readyState==="loading"?document.addEventListener("DOMContentLoaded",A):A(),document.addEventListener("fp-resv:tracking:push",function(s){if(!s||!s.detail)return;const t=s.detail,e=t&&(t.event||t.name);if(!e)return;const i=t.payload||t.data||{};u(e,i&&typeof i=="object"?i:{})}),f.FormApp=y,Object.defineProperty(f,Symbol.toStringTag,{value:"Module"}),f})({});
